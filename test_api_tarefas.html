<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Tarefas</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .log {
            background: #252526;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #007acc;
        }
        .error {
            border-left-color: #f48771;
            background: #3d2020;
        }
        .success {
            border-left-color: #89d185;
            background: #1e3a1e;
        }
        .warning {
            border-left-color: #f2cc60;
            background: #3d3420;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #dcdcaa; }
        pre {
            background: #1e1e1e;
            padding: 10px;
            overflow-x: auto;
            border: 1px solid #3c3c3c;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1177bb;
        }
    </style>
</head>
<body>
    <h1>üîç Teste de Diagn√≥stico - API Tarefas</h1>

    <button onclick="testarAPI()">üöÄ Executar Teste Completo</button>
    <button onclick="limparLogs()">üóëÔ∏è Limpar Logs</button>

    <div id="logs"></div>

    <script>
        const BASE_URL = 'http://sh00086.teste.website/~hg253b74';
        let logContainer = document.getElementById('logs');

        function limparLogs() {
            logContainer.innerHTML = '';
        }

        function log(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            logContainer.appendChild(div);
            console.log(message);
        }

        function logJSON(title, obj) {
            log(`<strong>${title}:</strong><pre>${JSON.stringify(obj, null, 2)}</pre>`);
        }

        async function testarAPI() {
            limparLogs();
            log('<h2>üß™ Iniciando testes...</h2>');

            // 1. Verificar token
            log('<h2>1Ô∏è‚É£ Verificando Token JWT</h2>');
            const token = localStorage.getItem('token');
            if (!token) {
                log('‚ùå Token n√£o encontrado no localStorage', 'error');
                log('üí° Fa√ßa login primeiro no sistema principal', 'warning');
                return;
            }
            log('‚úÖ Token encontrado', 'success');
            log(`Token (primeiros 50 chars): ${token.substring(0, 50)}...`);

            // 2. Verificar usu√°rio
            log('<h2>2Ô∏è‚É£ Verificando Usu√°rio Logado</h2>');
            const usuario = localStorage.getItem('usuario');
            if (usuario) {
                const user = JSON.parse(usuario);
                logJSON('Usu√°rio', user);
                log(`‚úÖ Logado como: ${user.nome} (${user.tipo})`, 'success');
            }

            // 3. Testar API de Auth (verificar token)
            log('<h2>3Ô∏è‚É£ Testando API de Autentica√ß√£o</h2>');
            try {
                const authResponse = await fetch(`${BASE_URL}/api_auth.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ action: 'verify' })
                });

                log(`Status: ${authResponse.status} ${authResponse.statusText}`);

                if (authResponse.ok) {
                    const authData = await authResponse.json();
                    logJSON('Resposta de Autentica√ß√£o', authData);

                    if (authData.dados && authData.dados.permissoes) {
                        log('‚úÖ Permiss√µes carregadas', 'success');
                        logJSON('Permiss√µes do usu√°rio', authData.dados.permissoes);

                        // Verificar se tem permiss√£o de tarefas
                        const tarefasPerm = authData.dados.permissoes.find(p => p.modulo === 'tarefas');
                        if (tarefasPerm) {
                            log('‚úÖ M√≥dulo "tarefas" encontrado nas permiss√µes', 'success');
                            logJSON('Permiss√µes de Tarefas', tarefasPerm);
                        } else {
                            log('‚ö†Ô∏è M√≥dulo "tarefas" N√ÉO encontrado nas permiss√µes', 'warning');
                        }
                    }
                } else {
                    const errorText = await authResponse.text();
                    log(`‚ùå Erro na autentica√ß√£o: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erro ao chamar API de Auth: ${error.message}`, 'error');
            }

            // 4. Testar API de Tarefas
            log('<h2>4Ô∏è‚É£ Testando API de Tarefas (GET)</h2>');
            try {
                const tarefasResponse = await fetch(`${BASE_URL}/api_tarefas.php`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                log(`Status: ${tarefasResponse.status} ${tarefasResponse.statusText}`);

                if (tarefasResponse.ok) {
                    const tarefasData = await tarefasResponse.json();
                    logJSON('Resposta de Tarefas', tarefasData);

                    if (tarefasData.sucesso) {
                        log(`‚úÖ API funcionando! ${tarefasData.dados?.length || 0} tarefas retornadas`, 'success');
                    } else {
                        log(`‚ö†Ô∏è API retornou sucesso=false: ${tarefasData.mensagem}`, 'warning');
                    }
                } else {
                    const errorText = await tarefasResponse.text();
                    log(`‚ùå ERRO ${tarefasResponse.status}: ${errorText}`, 'error');

                    // Tentar parsear como JSON
                    try {
                        const errorJSON = JSON.parse(errorText);
                        logJSON('Detalhes do Erro', errorJSON);
                    } catch (e) {
                        log('Resposta n√£o √© JSON v√°lido. Texto bruto:', 'error');
                        log(`<pre>${errorText.substring(0, 1000)}</pre>`, 'error');
                    }
                }
            } catch (error) {
                log(`‚ùå Erro ao chamar API de Tarefas: ${error.message}`, 'error');
            }

            // 5. Diagn√≥stico final
            log('<h2>5Ô∏è‚É£ Diagn√≥stico Final</h2>');
            log('Se voc√™ v√™ erro 500, as poss√≠veis causas s√£o:', 'warning');
            log('1. Coluna modulos.ativo ainda √© ENUM (n√£o foi migrada)', 'warning');
            log('2. M√≥dulo "tarefas" n√£o existe na tabela modulos', 'warning');
            log('3. Erro de sintaxe SQL no PHP', 'warning');
            log('4. Erro de permiss√µes do banco de dados', 'warning');

            log('<h2>‚úÖ Teste conclu√≠do!</h2>');
        }

        // Auto-executar ao carregar
        window.addEventListener('load', () => {
            log('P√°gina carregada. Clique em "Executar Teste" para come√ßar.');
        });
    </script>
</body>
</html>
