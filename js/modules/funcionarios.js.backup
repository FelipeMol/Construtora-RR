// ========================================
// MÓDULO DE FUNCIONÁRIOS
// ========================================

import { FuncionariosAPI } from './api.js';
import { funcionariosActions, empresasActions } from './store.js';
import { showNotification, showLoading, hideLoading, confirmar } from './ui.js';
import { TableRows, Badge, TableActions } from './components.js';

/**
 * Inicializar módulo de funcionários
 */
export async function initFuncionarios() {
    await carregarFuncionarios();
    setupEventListeners();
}

/**
 * Carregar funcionários do backend
 */
export async function carregarFuncionarios() {
    try {
        showLoading('Carregando funcionários...');
        const response = await FuncionariosAPI.listar();

        if (response.sucesso) {
            funcionariosActions.set(response.dados || []);
            renderizarFuncionarios();
        } else {
            showNotification(response.mensagem || 'Erro ao carregar funcionários', 'error');
        }
    } catch (error) {
        console.error('Erro ao carregar funcionários:', error);
        showNotification('Erro ao carregar funcionários', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Popular select de empresas no formulário de funcionários
 */
function popularSelectEmpresas() {
    const empresas = empresasActions.getAll();
    const selects = [
        document.getElementById('funcionario-empresa'),
        document.getElementById('edit-funcionario-empresa')
    ];

    selects.forEach(select => {
        if (!select) return;

        // Manter valor atual
        const valorAtual = select.value;

        // Limpar e popular
        select.innerHTML = '<option value="">Selecione uma empresa...</option>' +
            empresas.map(e => `<option value="${e.id}">${e.nome}</option>`).join('');

        // Restaurar valor
        if (valorAtual) select.value = valorAtual;
    });
}

/**
 * Renderizar tabela de funcionários
 */
export function renderizarFuncionarios() {
    const funcionarios = funcionariosActions.getAll();
    const empresas = empresasActions.getAll();
    const tbody = document.getElementById('tabela-funcionarios');

    // Popular selects
    popularSelectEmpresas();

    if (!tbody) {
        console.error('Elemento tabela-funcionarios não encontrado');
        return;
    }

    const html = TableRows({
        colunas: [
            {
                field: 'nome',
                label: 'Funcionário',
                render: (v, item) => `<strong>${v}</strong>`
            },
            {
                field: 'funcao',
                label: 'Função',
                render: (v) => v || '-'
            },
            {
                field: 'empresa_id',
                label: 'Empresa',
                render: (v) => {
                    const empresa = empresas.find(e => e.id == v);
                    return empresa ? empresa.nome : '-';
                }
            },
            {
                field: 'situacao',
                label: 'Situação',
                render: (v) => Badge({
                    texto: v,
                    tipo: v === 'Ativo' ? 'success' : 'secondary'
                })
            }
        ],
        dados: funcionarios,
        acoes: (item) => TableActions(item, {
            onEdit: 'editarFuncionario',
            onDelete: 'excluirFuncionario'
        })
    });

    tbody.innerHTML = html;
}

/**
 * Setup event listeners
 */
function setupEventListeners() {
    const form = document.getElementById('form-funcionario');

    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await adicionarFuncionario();
        });
    }
}

/**
 * Adicionar novo funcionário
 */
export async function adicionarFuncionario() {
    const nome = document.getElementById('funcionario-nome')?.value?.trim();
    const funcao = document.getElementById('funcionario-funcao')?.value?.trim();
    const empresaId = document.getElementById('funcionario-empresa')?.value;
    const cpf = document.getElementById('funcionario-cpf')?.value?.trim();
    const telefone = document.getElementById('funcionario-telefone')?.value?.trim();
    const situacao = document.getElementById('funcionario-situacao')?.value || 'Ativo';

    // Validações
    if (!nome) {
        showNotification('Nome é obrigatório', 'error');
        return;
    }


    try {
        showLoading('Salvando funcionário...');

        const response = await FuncionariosAPI.criar({
            nome,
            funcao: funcao || null,
            empresa_id: empresaId || null,
            cpf: cpf || null,
            telefone: telefone || null,
            situacao
        });

        if (response.sucesso) {
            showNotification('Funcionário adicionado com sucesso!', 'success');

            // Adicionar ao store
            funcionariosActions.add(response.dados);

            // Renderizar tabela
            renderizarFuncionarios();

            // Limpar formulário
            document.getElementById('form-funcionario')?.reset();
        } else {
            showNotification(response.mensagem || 'Erro ao adicionar funcionário', 'error');
        }
    } catch (error) {
        console.error('Erro ao adicionar funcionário:', error);
        showNotification('Erro ao adicionar funcionário', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Editar funcionário
 */
export function editarFuncionario(id) {
    const funcionario = funcionariosActions.findById(id);

    if (!funcionario) {
        showNotification('Funcionário não encontrado', 'error');
        return;
    }

    // Preencher modal
    document.getElementById('edit-funcionario-id').value = funcionario.id;
    document.getElementById('edit-funcionario-nome').value = funcionario.nome;
    document.getElementById('edit-funcionario-funcao').value = funcionario.funcao || '';
    document.getElementById('edit-funcionario-empresa').value = funcionario.empresa_id || '';
    document.getElementById('edit-funcionario-cpf').value = funcionario.cpf || '';
    document.getElementById('edit-funcionario-telefone').value = funcionario.telefone || '';
    document.getElementById('edit-funcionario-situacao').value = funcionario.situacao || 'Ativo';

    // Abrir modal
    const modal = document.getElementById('modal-editar-funcionario');
    if (modal) {
        modal.classList.add('active');
        modal.style.display = 'flex';
    }
}

/**
 * Fechar modal de edição
 */
export function fecharModalFuncionario() {
    const modal = document.getElementById('modal-editar-funcionario');
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
    }
}

/**
 * Salvar edição de funcionário
 */
export async function salvarEdicaoFuncionario(event) {
    event?.preventDefault();

    const id = document.getElementById('edit-funcionario-id')?.value;
    const nome = document.getElementById('edit-funcionario-nome')?.value?.trim();
    const funcao = document.getElementById('edit-funcionario-funcao')?.value?.trim();
    const empresaId = document.getElementById('edit-funcionario-empresa')?.value;
    const cpf = document.getElementById('edit-funcionario-cpf')?.value?.trim();
    const telefone = document.getElementById('edit-funcionario-telefone')?.value?.trim();
    const situacao = document.getElementById('edit-funcionario-situacao')?.value;

    // Validações
    if (!nome) {
        showNotification('Nome é obrigatório', 'error');
        return;
    }


    try {
        showLoading('Salvando alterações...');

        const response = await FuncionariosAPI.atualizar(id, {
            nome,
            funcao: funcao || null,
            empresa_id: empresaId || null,
            cpf: cpf || null,
            telefone: telefone || null,
            situacao
        });

        if (response.sucesso) {
            showNotification('Funcionário atualizado com sucesso!', 'success');

            // Atualizar no store
            funcionariosActions.update(id, response.dados);

            // Renderizar tabela
            renderizarFuncionarios();

            // Fechar modal
            fecharModalFuncionario();
        } else {
            showNotification(response.mensagem || 'Erro ao atualizar funcionário', 'error');
        }
    } catch (error) {
        console.error('Erro ao atualizar funcionário:', error);
        showNotification('Erro ao atualizar funcionário', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Excluir funcionário
 */
export async function excluirFuncionario(id) {
    const funcionario = funcionariosActions.findById(id);

    if (!funcionario) {
        showNotification('Funcionário não encontrado', 'error');
        return;
    }

    const confirmado = await confirmar(
        `Tem certeza que deseja excluir o funcionário <strong>${funcionario.nome}</strong>?`,
        'Excluir Funcionário'
    );

    if (!confirmado) return;

    try {
        showLoading('Excluindo funcionário...');

        const response = await FuncionariosAPI.excluir(id);

        if (response.sucesso) {
            showNotification('Funcionário excluído com sucesso!', 'success');

            // Remover do store
            funcionariosActions.remove(id);

            // Renderizar tabela
            renderizarFuncionarios();
        } else {
            showNotification(response.mensagem || 'Erro ao excluir funcionário', 'error');
        }
    } catch (error) {
        console.error('Erro ao excluir funcionário:', error);
        showNotification('Erro ao excluir funcionário', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Exportar funções para window (compatibilidade com onclick)
 */
if (typeof window !== 'undefined') {
    window.editarFuncionario = editarFuncionario;
    window.excluirFuncionario = excluirFuncionario;
    window.fecharModalFuncionario = fecharModalFuncionario;
    window.salvarEdicaoFuncionario = salvarEdicaoFuncionario;
}
