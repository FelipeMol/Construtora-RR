// ========================================
// MÓDULO DE OBRAS
// ========================================

import { ObrasAPI } from './api.js';
import { obrasActions } from './store.js';
import { showNotification, showLoading, hideLoading, confirmar } from './ui.js';
import { TableRows, TableActions } from './components.js';

/**
 * Inicializar módulo de obras
 */
export async function initObras() {
    await carregarObras();
    setupEventListeners();
}

/**
 * Carregar obras do backend
 */
export async function carregarObras() {
    try {
        showLoading('Carregando obras...');
        const response = await ObrasAPI.listar();

        if (response.sucesso) {
            obrasActions.set(response.dados || []);
            renderizarObras();
        } else {
            showNotification(response.mensagem || 'Erro ao carregar obras', 'error');
        }
    } catch (error) {
        console.error('Erro ao carregar obras:', error);
        showNotification('Erro ao carregar obras', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Renderizar tabela de obras
 */
export function renderizarObras() {
    const obras = obrasActions.getAll();
    const tbody = document.getElementById('tabela-obras');

    if (!tbody) {
        console.error('Elemento tabela-obras não encontrado');
        return;
    }

    const html = TableRows({
        colunas: [
            {
                field: 'nome',
                label: 'Obra',
                render: (v) => `<strong>${v}</strong>`
            },
            {
                field: 'responsavel',
                label: 'Responsável',
                render: (v) => v || '-'
            },
            {
                field: 'cidade',
                label: 'Cidade',
                render: (v) => v || '-'
            }
        ],
        dados: obras,
        acoes: (item) => TableActions(item, {
            onEdit: 'editarObra',
            onDelete: 'excluirObra'
        })
    });

    tbody.innerHTML = html;
}

/**
 * Setup event listeners
 */
function setupEventListeners() {
    const form = document.getElementById('form-obra');

    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await adicionarObra();
        });
    }
}

/**
 * Adicionar nova obra
 */
export async function adicionarObra() {
    const nome = document.getElementById('obra-nome')?.value?.trim();
    const responsavel = document.getElementById('obra-responsavel')?.value?.trim();
    const cidade = document.getElementById('obra-cidade')?.value?.trim();

    // Validações
    if (!nome) {
        showNotification('Nome da obra é obrigatório', 'error');
        return;
    }

    try {
        showLoading('Salvando obra...');

        const response = await ObrasAPI.criar({
            nome,
            responsavel: responsavel || null,
            cidade: cidade || null
        });

        if (response.sucesso) {
            showNotification('Obra adicionada com sucesso!', 'success');

            // Adicionar ao store
            obrasActions.add(response.dados);

            // Renderizar tabela
            renderizarObras();

            // Limpar formulário
            document.getElementById('form-obra')?.reset();
        } else {
            showNotification(response.mensagem || 'Erro ao adicionar obra', 'error');
        }
    } catch (error) {
        console.error('Erro ao adicionar obra:', error);
        showNotification('Erro ao adicionar obra', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Editar obra
 */
export function editarObra(id) {
    const obra = obrasActions.findById(id);

    if (!obra) {
        showNotification('Obra não encontrada', 'error');
        return;
    }

    // Preencher modal
    document.getElementById('edit-obra-id').value = obra.id;
    document.getElementById('edit-obra-nome').value = obra.nome;
    document.getElementById('edit-obra-responsavel').value = obra.responsavel || '';
    document.getElementById('edit-obra-cidade').value = obra.cidade || '';

    // Abrir modal
    const modal = document.getElementById('modal-editar-obra');
    if (modal) {
        modal.classList.add('active');
        modal.style.display = 'flex';
    }
}

/**
 * Fechar modal de edição
 */
export function fecharModalObra() {
    const modal = document.getElementById('modal-editar-obra');
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
    }
}

/**
 * Salvar edição de obra
 */
export async function salvarEdicaoObra(event) {
    event?.preventDefault();

    const id = document.getElementById('edit-obra-id')?.value;
    const nome = document.getElementById('edit-obra-nome')?.value?.trim();
    const responsavel = document.getElementById('edit-obra-responsavel')?.value?.trim();
    const cidade = document.getElementById('edit-obra-cidade')?.value?.trim();

    // Validações
    if (!nome) {
        showNotification('Nome da obra é obrigatório', 'error');
        return;
    }

    try {
        showLoading('Salvando alterações...');

        const response = await ObrasAPI.atualizar(id, {
            nome,
            responsavel: responsavel || null,
            cidade: cidade || null
        });

        if (response.sucesso) {
            showNotification('Obra atualizada com sucesso!', 'success');

            // Atualizar no store
            obrasActions.update(id, response.dados);

            // Renderizar tabela
            renderizarObras();

            // Fechar modal
            fecharModalObra();
        } else {
            showNotification(response.mensagem || 'Erro ao atualizar obra', 'error');
        }
    } catch (error) {
        console.error('Erro ao atualizar obra:', error);
        showNotification('Erro ao atualizar obra', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Excluir obra
 */
export async function excluirObra(id) {
    const obra = obrasActions.findById(id);

    if (!obra) {
        showNotification('Obra não encontrada', 'error');
        return;
    }

    const confirmado = await confirmar(
        `Tem certeza que deseja excluir a obra <strong>${obra.nome}</strong>?`,
        'Excluir Obra'
    );

    if (!confirmado) return;

    try {
        showLoading('Excluindo obra...');

        const response = await ObrasAPI.excluir(id);

        if (response.sucesso) {
            showNotification('Obra excluída com sucesso!', 'success');

            // Remover do store
            obrasActions.remove(id);

            // Renderizar tabela
            renderizarObras();
        } else {
            showNotification(response.mensagem || 'Erro ao excluir obra', 'error');
        }
    } catch (error) {
        console.error('Erro ao excluir obra:', error);
        showNotification('Erro ao excluir obra', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Exportar funções para window (compatibilidade com onclick)
 */
if (typeof window !== 'undefined') {
    window.editarObra = editarObra;
    window.excluirObra = excluirObra;
    window.fecharModalObra = fecharModalObra;
    window.salvarEdicaoObra = salvarEdicaoObra;
}
